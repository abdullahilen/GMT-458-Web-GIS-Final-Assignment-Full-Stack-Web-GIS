<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSpatial Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- DARK THEME VARIABLES --- */
        :root {
            --bg-dark: #1a1a1a;
            --sidebar-dark: #121212;
            --accent-neon: #00e676;
            --text-white: #ededed;
            --danger-color: #ff4444;
            --edit-color: #2fc6d7;
        }

        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: #000; color: white; }

        /* LOGIN SCREEN */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1519501025264-65ba15a82390?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        #auth-screen::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
        }
        .auth-box {
            position: relative; z-index: 2001; background: rgba(30, 30, 30, 0.95); 
            border: 1px solid #333; padding: 2.5rem; border-radius: 8px; 
            box-shadow: 0 0 25px rgba(0, 230, 118, 0.15); text-align: center; width: 320px;
        }
        .auth-box h2 { color: white; margin: 0 0 10px 0; letter-spacing: 2px; }
        .auth-box p { color: #888; margin-bottom: 25px; font-size: 0.85rem; }
        input { 
            padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box;
            border: 1px solid #444; border-radius: 4px; background: #111; color: var(--accent-neon);
        }
        button { 
            padding: 12px; width: 100%; border: none; border-radius: 4px; 
            font-weight: bold; cursor: pointer; margin-top: 15px; letter-spacing: 1px;
        }
        .btn-login { background: var(--accent-neon); color: black; }
        .btn-register { background: #333; color: white; border: 1px solid #555; }
        .toggle-text { margin-top: 20px; font-size: 0.8rem; cursor: pointer; color: var(--accent-neon); }

        /* APP LAYOUT */
        #app-container { display: flex; height: 100vh; width: 100vw; }
        #sidebar { width: 340px; background: var(--sidebar-dark); border-right: 1px solid #333; display: flex; flex-direction: column; z-index: 1002; }
        #sidebar-header { padding: 20px; background: #0a0a0a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #sidebar-header h3 { margin: 0; font-size: 1.1rem; color: var(--accent-neon); }
        #points-list { flex: 1; overflow-y: auto; padding: 15px; background: #0a0a0a; }
        
        /* CARD & ICONS */
        .point-card { background: #181818; border: 1px solid #333; border-radius: 4px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .point-card:hover { background: #222; border-color: var(--accent-neon); }
        .point-header { display: flex; justify-content: space-between; align-items: center; }
        .sidebar-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 2px; opacity: 0.6; color: #fff; margin-top: 0; width: auto; }
        .icon-btn:hover { opacity: 1; transform: scale(1.2); }
        .icon-edit { color: var(--edit-color); }
        .icon-delete { color: var(--danger-color); }
        .point-title { font-weight: bold; color: #fff; }
        .point-desc { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .point-user { font-size: 0.7rem; color: #555; margin-top: 10px; }

        #map { flex: 1; }
        .btn-logout { background: transparent; border: 1px solid #444; padding: 4px 8px; color: #888; border-radius: 4px; cursor: pointer; font-size: 0.8rem; width: auto; margin-top: 0; }
        
        /* POPUP & MODAL */
        .leaflet-popup-content-wrapper { background: #222; color: #ededed; border: 1px solid var(--accent-neon); padding: 0; }
        .leaflet-popup-tip { background: #222; border: 1px solid var(--accent-neon); }
        
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--accent-neon); padding: 30px; width: 350px; border-radius: 6px; }
        .modal-box h3 { color: var(--accent-neon); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-box input, .modal-box textarea { width: 100%; background: #0a0a0a; border: 1px solid #333; color: white; padding: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { width: 50%; padding: 12px; }
        .btn-cancel { background: transparent; border: 1px solid #444; color: #888; }
        .btn-confirm { background: var(--accent-neon); color: black; border: none; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="form-title">SYSTEM LOGIN</h2>
            <p id="form-subtitle">Secure Access Required</p>
            <input type="text" id="username" placeholder="USER ID / CODENAME">
            <input type="password" id="password" placeholder="PASSWORD">
            <button id="main-btn" class="btn-login" onclick="handleAuth()">ACCESS SYSTEM</button>
            <p id="error-msg" style="color:#ff5252; margin-top: 10px; font-size: 0.9em;"></p>
            <p class="toggle-text" onclick="toggleMode()">New Unit? Register</p>
        </div>
    </div>

    <div id="app-container">
        <div id="sidebar">
            <div id="sidebar-header">
                <h3>PINS</h3>
                <button class="btn-logout" onclick="logout()">LOGOUT</button>
            </div>
            <div id="points-list">
                <p style="text-align:center; color:#444; margin-top:20px;">[ SEARCHING DATA... ]</p>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">NEW PIN</h3>
            <label style="color:#888; font-size:0.8rem;">PIN NAME</label>
            <input type="text" id="input-name" placeholder="ENTER NAME">
            <label style="color:#888; font-size:0.8rem;">DESCRIPTION</label>
            <textarea id="input-desc" rows="3" placeholder=""></textarea>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">CANCEL</button>
                <button class="btn-confirm" onclick="submitPoint()">SAVE</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        let map, markerLayer;
        let token = localStorage.getItem('gis_token');
        let isLoginMode = true;
        let tempLatLng = null;
        let editingId = null;
        let allPointsData = []; // Store point data here

        // Start App if logged in
        if (token) {
            showApp();
        }

        // --- AUTH FUNCTIONS ---
        function toggleMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('form-title');
            const btn = document.getElementById('main-btn');
            const toggle = document.querySelector('.toggle-text');

            if (isLoginMode) {
                title.innerText = "SYSTEM LOGIN";
                btn.innerText = "ACCESS SYSTEM";
                btn.className = "btn-login";
                toggle.innerText = "New Unit? Register";
            } else {
                title.innerText = "UNIT REGISTRATION";
                btn.innerText = "REGISTER";
                btn.className = "btn-register";
                toggle.innerText = "Existing Unit? Login";
            }
        }

        async function handleAuth() {
            const usernameInput = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const endpoint = isLoginMode ? '/api/auth/login' : '/api/auth/register';

            if (!usernameInput || !pass) {
                document.getElementById('error-msg').innerText = "Please fill all fields";
                return;
            }

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: usernameInput, password: pass })
                });
                
                const data = await res.json();

                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('gis_token', data.token);
                    localStorage.setItem('gis_username', usernameInput);

                    // --- ADMIN/USER INFO SAVED HERE ---
                    if (data.user) {
                        localStorage.setItem('role', data.user.role); 
                        localStorage.setItem('userId', data.user.id);
                    }

                    showApp();
                } else {
                    document.getElementById('error-msg').innerText = data.msg || "Authentication Failed";
                }
            } catch (err) { 
                console.error(err); 
                document.getElementById('error-msg').innerText = "Server Error";
            }
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            // Wait slightly for DOM to settle before initializing map
            setTimeout(() => {
                if (!map) initMap();
            }, 100);
        }

        function logout() {
            localStorage.removeItem('gis_token');
            localStorage.removeItem('gis_username');
            localStorage.removeItem('role');
            localStorage.removeItem('userId');
            location.reload();
        }

        // --- MAP FUNCTIONS ---
        function initMap() {
            map = L.map('map').setView([41.0082, 28.9784], 10);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20
            }).addTo(map);

            // Locate Button
            const locateControl = L.control({ position: 'topleft' });
            locateControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = 'ðŸ“';
                div.style.cssText = 'background:#111; color:#00e676; width:30px; height:30px; font-size:18px; line-height:30px; text-align:center; cursor:pointer; border:2px solid #444;';
                div.onclick = function() { map.locate({setView: true, maxZoom: 16}); };
                return div;
            };
            locateControl.addTo(map);

            map.on('locationfound', e => {
                L.circleMarker(e.latlng, { radius: 10, fillColor: "#00e676", color: "#fff", weight: 3, fillOpacity: 0.8 })
                 .addTo(map).bindPopup("TARGET ACQUIRED").openPopup();
            });

            // Right Click to Add Point
            map.on('contextmenu', (e) => {
                editingId = null; 
                document.getElementById('modal-title').innerText = "NEW PIN";
                document.getElementById('input-name').value = '';
                document.getElementById('input-desc').value = '';
                tempLatLng = e.latlng;
                document.getElementById('modal-overlay').style.display = 'flex';
                document.getElementById('input-name').focus();
            });

            loadPoints();
        }

        // --- LOAD POINTS (Unified Logic) ---
        async function loadPoints() {
            const currentToken = localStorage.getItem('gis_token'); 
            if (!currentToken) return;

            try {
                const res = await fetch('/api/layer/points', {
                    headers: { 'Authorization': currentToken }
                });

                if (!res.ok) {
                    console.error("Failed to load points");
                    return;
                }

                const allPoints = await res.json();
                if (!Array.isArray(allPoints)) return;

                allPointsData = allPoints;

                // Clear old markers
                if (typeof markerLayer !== 'undefined' && markerLayer) {
                    map.removeLayer(markerLayer);
                }
                markerLayer = L.featureGroup();

                // Clear Sidebar List
                const listContainer = document.getElementById('points-list');
                if (listContainer) listContainer.innerHTML = '';

                // Get Roles
                const currentUserId = localStorage.getItem('userId');
                const currentUserRole = localStorage.getItem('role');

                allPoints.forEach(p => {
                    const lat = parseFloat(p.lat);
                    const lng = parseFloat(p.lng);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng]);

                        // --- POPUP CONTENT ---
                        let popupContent = `
                            <div style="text-align: center; width: 200px; font-family: sans-serif; padding: 10px;">
                                <h3 style="margin: 0 0 5px 0; color: #00e676;">${p.name}</h3>
                                <p style="margin: 0 0 10px 0; color: #ccc; font-size: 13px; white-space: pre-wrap;">${p.description || "No description"}</p>
                                <div style="font-size: 11px; color: #888; margin-bottom: 10px;">
                                    By: ${p.username || 'Unknown'}
                                </div>
                        `;

                        // CHECK: Admin OR Owner
                        if (currentUserRole === 'admin' || currentUserId == p.user_id) {
                            popupContent += `
                                <div style="display:flex; gap:5px; justify-content:center;">
                                    <button onclick="startEditById(${p.id})" style="background:#2fc6d7; color:black; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; flex:1;">Edit</button>
                                    <button onclick="deletePoint(${p.id})" style="background:#ff4444; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; flex:1;">Delete</button>
                                </div>
                            `;
                        }
                        popupContent += `</div>`;
                        
                        marker.bindPopup(popupContent);
                        markerLayer.addLayer(marker);

                        // --- SIDEBAR LIST ITEM ---
                        if (listContainer) {
                            const card = document.createElement('div');
                            card.className = 'point-card';
                            
                            // Check Role for Sidebar Icons
                            let sidebarIcons = '';
                            if (currentUserRole === 'admin' || currentUserId == p.user_id) {
                                sidebarIcons = `
                                    <div class="sidebar-actions">
                                        <button class="icon-btn icon-edit" onclick="event.stopPropagation(); startEditById(${p.id})" title="Edit">âœŽ</button>
                                        <button class="icon-btn icon-delete" onclick="event.stopPropagation(); deletePoint(${p.id})" title="Delete">ðŸ—‘</button>
                                    </div>`;
                            }

                            card.innerHTML = `
                                <div class="point-header">
                                    <div class="point-title">${p.name}</div>
                                    ${sidebarIcons}
                                </div>
                                <div class="point-desc">${p.description || ""}</div>
                                <div class="point-user">By: ${p.username}</div>
                            `;
                            
                            card.onclick = () => {
                                map.flyTo([lat, lng], 16);
                                marker.openPopup();
                            };
                            listContainer.appendChild(card);
                        }
                    }
                });

                map.addLayer(markerLayer);

            } catch (err) {
                console.error("Error loading points:", err);
            }
        }

        // --- EDIT / DELETE / SAVE FUNCTIONS ---

        function startEditById(id) {
            const p = allPointsData.find(point => point.id === id);
            if (!p) return;

            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('input-name').value = p.name;
            document.getElementById('input-desc').value = p.description || "";
            document.getElementById('modal-title').innerText = "EDIT PIN DATA";
            
            editingId = id;
            map.closePopup();
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        async function submitPoint() {
            const name = document.getElementById('input-name').value;
            const description = document.getElementById('input-desc').value;
            if (!name) { alert("NAME REQUIRED"); return; }

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `/api/layer/points/${editingId}` : '/api/layer/points';
            const body = editingId ? { name, description } : { name, description, latitude: tempLatLng.lat, longitude: tempLatLng.lng };

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    closeModal();
                    loadPoints();
                    editingId = null;
                } else { alert("Operation Failed"); }
            } catch (err) { console.error(err); }
        }

        async function deletePoint(id) {
            if(!confirm("Are you sure you want to DELETE this point?")) return;
            try {
                const res = await fetch(`/api/layer/points/${id}`, {
                    method: 'DELETE', headers: { 'Authorization': token }
                });
                if (res.ok) loadPoints();
                else alert("Failed to delete (Are you authorized?)");
            } catch(err) { console.error(err); }
        }
    </script>
</body>
</html>